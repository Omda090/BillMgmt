@model BillMgmt.Models.ViewModels.BillVm

@* =========================================================
    #region Form (POST to Save)
    - Uses Html.BeginForm => FormPost (NOT Ajax) to save data.
    - AntiForgeryToken enabled.
    - If editing => include BillId hidden input.
    ========================================================= *@
<style>
    /* Bootstrap 3 friendly invalid style */
    .is-invalid {
        border-color: #d9534f !important;
        box-shadow: 0 0 0 0.2rem rgba(217,83,79,.15);
    }

       .form-group label { font-weight: 600; }
    #btnAddCustomer { line-height: 1.2; }
</style>

@using (Html.BeginForm("Save", "Bill", FormMethod.Post, new { id = "billForm" }))
{
    @* =========================================================
        Security: CSRF Protection
        - Generates anti-forgery token for POST request protection.
        - Must match [ValidateAntiForgeryToken] on Save action.
        ========================================================= *@
    @Html.AntiForgeryToken()
    @* true معناها: يعرض الأخطاء العامة فقط (التي بدون key)
    وأخطاء الحقول ستظهر بجانب الحقول عبر ValidationMessageFor *@
    @Html.ValidationSummary(true, "", new { @class = "alert alert-danger", style = "margin-bottom:12px;" })

    @* =====================  CHANGED PART (organized) =====================
        Edit support:
        - When BillId exists => send it back as hidden input.
        - Server uses it to decide Edit vs Create.
        ===================================================================== *@
    <div class="d-none">
        @if (Model?.BillId != null)
        {
            @Html.HiddenFor(x => x.BillId)
        }
    </div>

    @* =========================================================
        #region Header Section (Customer / Store / Total)
        ========================================================= *@
    <div style="border:1px solid #ccc;padding:12px;margin-bottom:12px;">
        <div style="display:flex;gap:12px;align-items:center;">
            <div>
                <label>عملاء</label><br />
               @Html.DropDownListFor(m => m.CustomerId, Model.Customers, "-- اختر العميل --",
        new { @class = "form-control", style = "width:220px;", id = "CustomerId" })

                <span class="input-group-btn">
                    <button type="button" id="btnAddCustomer" class="btn btn-success" title="Add Customer">
                        +
                    </button>
                </span>

            @Html.ValidationMessageFor(m => m.CustomerId, "", new { @class = "text-danger" })

            </div>

            <div>
                <label>مخازن</label><br />
                @Html.DropDownListFor(m => m.StoreId, Model.Stores, "-- اختر المخزن --",
        new { @class = "form-control", id = "StoreId", style = "width:220px;" })
                @Html.ValidationMessageFor(m => m.StoreId, "", new { @class = "text-danger" })
            </div>

            <div>
                <label>اجمالى الفاتورة</label><br />
                <input type="text" id="TotalAmount" class="form-control"
                       style="width:160px;background:#f7f7f7;" readonly
                       value="@Model.TotalAmount.ToString("0.00")" />
            </div>
        </div>
    </div>

    @* =========================================================
        #region Details Entry (Select product + qty + add button)
        - Product dropdown is filled by AJAX when store changes.
        - Stock/Price loaded by AJAX when product changes.
        ========================================================= *@
    <div style="border:1px solid #ccc;padding:12px;margin-bottom:12px;">
        <div style="display:flex;gap:12px;align-items:end;">
            <div>
                <label>المنتج</label><br />
                <select id="ProductId" class="form-control" style="width:280px;">
                    <option value="">-- اختر المخزن أولاً --</option>
                </select>
            </div>

            <div>
                <label>الرصيد بالمخزن</label><br />
                <input type="text" id="StockQty" class="form-control"
                       style="width:140px;background:#f7f7f7;" readonly />
                <small id="StockQtyError" class="text-danger"
                       style="display:none; margin-top:4px;"></small>
            </div>

            <div>
                <label>السعر</label><br />
                <input type="text" id="Price" class="form-control"
                       style="width:140px;background:#f7f7f7;" readonly />
            </div>

            <div>
                <label>الكمية المطلوبة</label><br />
                <input type="number" step="0.01" min="0" id="ReqQty"
                       class="form-control" style="width:140px;" />
                <small id="qtyError" class="text-danger" style="display:none;"></small>
                        </div>

            <div>
                <button type="button" id="btnAdd" class="btn btn-success">Add</button>
            </div>
        </div>
    </div>



    @* =========================================================
        #region Items Table (Model Binder Ready)
        - Important: name="Items[i].Field" so MVC binds correctly.
        - Existing items appear in Edit mode.
        ========================================================= *@
    <div style="border:1px solid #ccc;padding:12px;">
        <table class="table table-bordered" id="itemsTable">
            <thead>
                <tr>
                    <th style="width:60px;">#</th>
                    <th>المنتج</th>
                    <th style="width:120px;">السعر</th>
                    <th style="width:120px;">الكمية</th>
                    <th style="width:120px;">الإجمالى</th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items != null && Model.Items.Any())
                {
                    for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td class="rowNo">@(i + 1)</td>
                            <td>
                                @Html.Hidden($"Items[{i}].ProductId", Model.Items[i].ProductId, new { @class = "hProductId" })
                                <span class="pName">@Model.Items[i].ProductName</span>
                            </td>
                            <td>
                                @Html.TextBox($"Items[{i}].Price", Model.Items[i].Price.ToString("0.00"),
                                    new { @class = "form-control txtPrice", @readonly = "readonly", style = "background:#f7f7f7;" })
                            </td>
                            <td>
                                @Html.TextBox($"Items[{i}].Qty", Model.Items[i].Qty.ToString("0.00"),
                                    new { @class = "form-control txtQty", @readonly = "readonly", style = "background:#f7f7f7;" })
                            </td>
                            <td class="lineTotal">@((Model.Items[i].Price * Model.Items[i].Qty).ToString("0.00"))</td>
                            <td><button type="button" class="btn btn-danger btn-sm btnRemove">X</button></td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        @Html.ValidationMessage("Items", new { @class = "text-danger", style = "display:block;margin-top:8px;" })
        @* =========================================================
            #region Action Buttons
            ========================================================= *@
        <a href="@Url.Action("Index","Bill")" class="btn btn-default">Back to Index</a>
        <button type="submit" name="postAction" value="save" class="btn btn-primary">Save</button>
    </div>


}

<div id="customerModalContainer"></div>


@* =========================================================
    #region Scripts
    IMPORTANT:
    - Put scripts inside @section scripts (recommended)
    - Load jQuery only ONCE (Layout is better).
    ========================================================= *@
@section scripts {


    <script>
        function showQtyError(msg) {
            $("#qtyError").text(msg).show();
        }
        function clearQtyError() {
            $("#qtyError").hide().text("");
        }


        // =========================
        // Helpers: totals + reindex
        // =========================
        function recalcTotal() {
            var total = 0;
            $("#itemsTable tbody tr").each(function () {
                var lt = parseFloat($(this).find(".lineTotal").text() || "0");
                total += lt;
            });
            $("#TotalAmount").val(total.toFixed(2));
        }

        function reindexRows() {
            $("#itemsTable tbody tr").each(function (idx) {
                $(this).find(".rowNo").text(idx + 1);

                // Ensure MVC binder names Items[0], Items[1]...
                $(this).find("input, select").each(function () {
                    var name = $(this).attr("name");
                    if (!name) return;

                    name = name.replace(/Items\[\d+\]/g, "Items[" + idx + "]");
                    $(this).attr("name", name);
                });
            });
        }

        // =========================
        // Silent validation UI
        // =========================


        $(document).on("change keyup", "#CustomerId,#StoreId,#ProductId,#ReqQty", function () {
            $(this).removeClass("is-invalid");
            clearQtyError();
        });

        // =========================
        // Store -> load products
        // =========================
        $("#StoreId").change(function () {
            var storeId = $(this).val();

            // Professional placeholder text
            $("#ProductId").html('<option value="">-- اختر المنتج --</option>');
            $("#StockQty").val("");
            $("#Price").val("");

            if (!storeId) return;

            $.getJSON('@Url.Action("GetProductsByStore","Bill")', { storeId: storeId })
                .done(function (list) {
                    var opt = '<option value="">-- اختر المنتج --</option>';
                    $.each(list, function (i, x) {
                        opt += '<option value="' + x.id + '">' + x.name + '</option>';
                    });
                    $("#ProductId").html(opt);
                });
        });
        // =========================
        // Product -> load stock/price
        // =========================
        $("#ProductId").change(function () {
            var storeId = $("#StoreId").val();
            var productId = $(this).val();

            $("#StockQty").val("");
            $("#Price").val("");

            clearStockQtyError();
            clearReqQtyError();
            $("#StockQty").removeClass("is-invalid");

            if (!storeId || !productId) return;

            $.getJSON('@Url.Action("GetProductInfo","Bill")', { storeId: storeId, productId: productId })
                .done(function (r) {
                    if (!r || !r.ok) return;
                    $("#StockQty").val(parseFloat(r.stockQty).toFixed(2));
                    $("#Price").val(parseFloat(r.price).toFixed(2));



                    // هنا: لو الرصيد = 0 خلي الرصيد نفسه يبقى invalid
                    var stock = parseFloat(r.stockQty || "0");
                    if (stock <= 0) {
                        markInvalid($("#StockQty"));
                    } else {
                        $("#StockQty").removeClass("is-invalid");
                    }

                    if (parseFloat(r.stockQty) <= 0) {
                        showStockQtyError("هذا المنتج غير متوفر بالمخزن (الرصيد = 0).");
                    } else {
                        clearStockQtyError();
                    }
                });
        });
     
        // =========================
        // Add item row (NO messages)
        // =========================
        //$("#btnadd").click(function () {
        //    clearinvalid();

        //    var storeid = $("#storeid").val();
        //    var productid = $("#productid").val();
        //    var productname = $("#productid option:selected").text();
        //    var stockqty = parsefloat($("#stockqty").val() || "0");
        //    var price = parsefloat($("#price").val() || "0");
        //    var qty = parsefloat($("#reqqty").val() || "0");

        //    var ok = true;

        //    if (!storeid) { markinvalid($("#storeid")); ok = false; }
        //    if (!productid) { markinvalid($("#productid")); ok = false; }
        //    if (!(qty > 0)) { markinvalid($("#reqqty")); ok = false; }
        //    if (ok && qty > stockqty) { markinvalid($("#reqqty")); ok = false; }

        //    // prevent duplicates
        //    if (ok) {
        //        var exists = false;
        //        $("#itemstable tbody .hproductid").each(function () {
        //            if ($(this).val() == productid) exists = true;
        //        });
        //        if (exists) { markinvalid($("#productid")); ok = false; }
        //    }

        //    if (!ok) return;

        //    var idx = $("#itemstable tbody tr").length;
        //    var linetotal = price * qty;

        //    var row = ''
        //        + '<tr>'
        //        + '  <td class="rowno">' + (idx + 1) + '</td>'
        //        + '  <td>'
        //        + '     <input type="hidden" class="hproductid" name="items[' + idx + '].productid" value="' + productid + '" />'
        //        + '     <span class="pname">' + productname + '</span>'
        //        + '  </td>'
        //        + '  <td>'
        //        + '     <input type="text" class="form-control txtprice" name="items[' + idx + '].price" value="' + price.tofixed(2) + '" readonly style="background:#f7f7f7;" />'
        //        + '  </td>'
        //        + '  <td>'
        //        + '     <input type="text" class="form-control txtqty" name="items[' + idx + '].qty" value="' + qty.tofixed(2) + '" readonly style="background:#f7f7f7;" />'
        //        + '  </td>'
        //        + '  <td class="linetotal">' + linetotal.tofixed(2) + '</td>'
        //        + '  <td><button type="button" class="btn btn-danger btn-sm btnremove">x</button></td>'
        //        + '</tr>';

        //    $("#itemstable tbody").append(row);

        //    // keep product selected (no reset)
        //    $("#stockqty").val("");
        //    $("#price").val("");
        //    $("#reqqty").val("");

        //    recalctotal();
        //});

        $("#btnAdd").click(function () {
            clearInvalid();

            var storeId = $("#StoreId").val();
            var productId = $("#ProductId").val();
            var productName = $("#ProductId option:selected").text();

            var stockQty = parseFloat($("#StockQty").val());
            var price = parseFloat($("#Price").val());
            var qty = parseFloat($("#ReqQty").val());

            // لو القيم فاضية تتحول NaN
            if (isNaN(stockQty)) stockQty = 0;
            if (isNaN(price)) price = 0;
            if (isNaN(qty)) qty = 0;

            var ok = true;

            // 1) لازم مخزن
            if (!storeId) {
                markInvalid($("#StoreId"));
                ok = false;
            }

            // 2) لازم منتج
            if (!productId) {
                markInvalid($("#ProductId"));
                ok = false;
            }

            // 3) لازم تكون بيانات المنتج اتجابت (رصيد/سعر)
            // أهم شرط: لو الرصيد = 0 ممنوع تضيف
            if (ok && stockQty <= 0) {
                markInvalid($("#ProductId"));
                showQtyError("هذا المنتج غير متوفر في المخزن (الرصيد = 0).");
                ok = false;
            }

            // 4) الكمية لازم > 0
            if (ok && !(qty > 0)) {
                markInvalid($("#ReqQty"));
                showQtyError("أدخل كمية أكبر من صفر.");
                ok = false;
            }

            // 5) الكمية لا تتجاوز الرصيد
            if (ok && qty > stockQty) {
                markInvalid($("#ReqQty"));
                showQtyError("الكمية المطلوبة أكبر من الرصيد بالمخزن.");
                ok = false;
            }

            // 6) منع التكرار
            if (ok) {
                var exists = false;
                $("#itemsTable tbody .hProductId").each(function () {
                    if ($(this).val() == productId) exists = true;
                });
                if (exists) {
                    markInvalid($("#ProductId"));
                    showQtyError("هذا المنتج مضاف بالفعل داخل الفاتورة.");
                    ok = false;
                }
            }

            if (!ok) return;

            // ✅ إضافة الصف
            var idx = $("#itemsTable tbody tr").length;
            var lineTotal = price * qty;

            var row = ''
                + '<tr>'
                + '  <td class="rowNo">' + (idx + 1) + '</td>'
                + '  <td>'
                + '     <input type="hidden" class="hProductId" name="Items[' + idx + '].ProductId" value="' + productId + '" />'
                + '     <span class="pName">' + productName + '</span>'
                + '  </td>'
                + '  <td>'
                + '     <input type="text" class="form-control txtPrice" name="Items[' + idx + '].Price" value="' + price.toFixed(2) + '" readonly style="background:#f7f7f7;" />'
                + '  </td>'
                + '  <td>'
                + '     <input type="text" class="form-control txtQty" name="Items[' + idx + '].Qty" value="' + qty.toFixed(2) + '" readonly style="background:#f7f7f7;" />'
                + '  </td>'
                + '  <td class="lineTotal">' + lineTotal.toFixed(2) + '</td>'
                + '  <td><button type="button" class="btn btn-danger btn-sm btnRemove">X</button></td>'
                + '</tr>';

            $("#itemsTable tbody").append(row);

            $("#StockQty").val("");
            $("#Price").val("");
            $("#ReqQty").val("");

            recalcTotal();
        });


        function clearInvalid() {
            $("#StoreId,#ProductId,#ReqQty").removeClass("is-invalid");
            clearQtyError();
        }

        // =========================
        // Remove row
        // =========================
        $(document).on("click", ".btnRemove", function () {
            $(this).closest("tr").remove();
            reindexRows();
            recalcTotal();
        });

        // =========================
        // Init
        // =========================
        $(function () {
            recalcTotal();

            var storeId = $("#StoreId").val();
            if (storeId) {
                $("#StoreId").trigger("change");
            }
        });

        

    </script>
}
